---
import Layout from '../../layouts/Layout.astro';
import propertiesData from '../../data/properties.json';
import '../../styles/property-detail.css';
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/pagination';
import 'swiper/css/thumbs';

interface Property {
	id: string;
	title: string;
	address: string;
	price: number;
	surface: number;
	rooms: number;
	description: string;
	images: string[];
	features: string[];
}

export async function getStaticPaths() {
	const properties: Property[] = propertiesData;
	return properties.map((property) => ({
		params: { id: property.id },
	}));
}

const { id } = Astro.params;
const properties: Property[] = propertiesData;
const property = properties.find(p => p.id === id);

// Redirect to index if property doesn't exist
if (!property) {
	return Astro.redirect('/');
}
---

<Layout title={property.title}>
	<main>
		<a href="/" class="back-link" id="back-link">
			<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M19 12H5M12 19l-7-7 7-7"/>
			</svg>
			Retour à la liste
		</a>

		<div class="container">
			<div class="property-header">
				<div class="property-title-section">
					<h1>{property.title}</h1>
					<p class="property-address">
						<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
							<circle cx="12" cy="10" r="3"/>
						</svg>
						{property.address}
					</p>
					<div class="property-badge">Disponible</div>
				</div>
				<div class="property-price-large">
					<span class="price-amount">{property.price}</span>
					<span class="price-unit">€/mois</span>
				</div>
			</div>

			{property.images && property.images.length > 0 && (
				<div class="property-gallery">
					<div class="main-swiper" data-swiper="main">
						<div class="swiper-wrapper">
							{property.images.map((image, index) => (
								<div class="swiper-slide" key={index}>
									<img src={image} alt={`${property.title} - Image ${index + 1}`} />
								</div>
							))}
						</div>
						<div class="swiper-button-next"></div>
						<div class="swiper-button-prev"></div>
						<div class="swiper-pagination"></div>
					</div>
					{property.images.length > 1 && (
						<div class="thumbs-swiper" data-swiper="thumbs">
							<div class="swiper-wrapper">
								{property.images.map((image, index) => (
									<div class="swiper-slide" key={index}>
										<img src={image} alt={`${property.title} - Miniature ${index + 1}`} />
									</div>
								))}
							</div>
						</div>
					)}
				</div>
			)}

			<div class="property-content-grid">
				<div class="property-main">
					<section class="property-section">
						<h2>Description</h2>
						<p>{property.description}</p>
					</section>

					{property.features && property.features.length > 0 && (
						<section class="property-section">
							<h2>Caractéristiques</h2>
							<div class="features-grid">
								{property.features.map((feature) => (
									<div class="feature-item">
										<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<polyline points="20 6 9 17 4 12"/>
										</svg>
										{feature}
									</div>
								))}
							</div>
						</section>
					)}
				</div>

				<aside class="property-sidebar">
					<div class="info-card">
						<h3>Informations</h3>
						<div class="info-item">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
								<line x1="9" y1="3" x2="9" y2="21"/>
								<line x1="3" y1="9" x2="21" y2="9"/>
							</svg>
							<div>
								<div class="info-label">Surface</div>
								<div class="info-value">{property.surface} m²</div>
							</div>
						</div>
						<div class="info-item">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
								<polyline points="9 22 9 12 15 12 15 22"/>
							</svg>
							<div>
								<div class="info-label">Pièces</div>
								<div class="info-value">{property.rooms} pièce{property.rooms > 1 ? 's' : ''}</div>
							</div>
						</div>
						<div class="info-item">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<line x1="12" y1="1" x2="12" y2="23"/>
								<path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
							</svg>
							<div>
								<div class="info-label">Loyer</div>
								<div class="info-value">{property.price} €/mois</div>
							</div>
						</div>
					</div>

					<div class="contact-card">
						<h3>Intéressé(e) ?</h3>
						<p>Contactez-nous pour organiser une visite ou obtenir plus d'informations.</p>
						<div class="contact-buttons">
							<a 
								href="mailto:christophe-lapierre@orange.fr" 
								class="btn btn-primary"
								id="email-button"
								data-property-id={property.id}
								data-property-title={property.title}
							>
								<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
									<polyline points="22,6 12,13 2,6"/>
								</svg>
								Envoyer un email
							</a>
							<a 
								href="tel:+33601767543" 
								class="btn btn-secondary"
								id="phone-button"
								data-property-id={property.id}
								data-property-title={property.title}
							>
								<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
								</svg>
								Appeler
							</a>
						</div>
					</div>
				</aside>
			</div>
		</div>
	</main>
</Layout>

<script define:vars={{ propertyId: property.id, propertyTitle: property.title }}>
	import Swiper from 'swiper';
	import { Navigation, Pagination, Thumbs } from 'swiper/modules';
	import { events } from '../../utils/posthog';
	
	events.propertyViewed(propertyId, propertyTitle);
	
	document.addEventListener('DOMContentLoaded', () => {
		const mainSwiperEl = document.querySelector('[data-swiper="main"]');
		const thumbsSwiperEl = document.querySelector('[data-swiper="thumbs"]');
		
		const backLink = document.getElementById('back-link');
		if (backLink) {
			backLink.addEventListener('click', () => {
				events.backToListClicked();
			});
		}
		
		const emailButton = document.getElementById('email-button');
		if (emailButton) {
			emailButton.addEventListener('click', () => {
				events.emailClicked(propertyId, propertyTitle);
			});
		}
		
		const phoneButton = document.getElementById('phone-button');
		if (phoneButton) {
			phoneButton.addEventListener('click', () => {
				events.phoneClicked(propertyId, propertyTitle);
			});
		}
		
		if (mainSwiperEl && thumbsSwiperEl) {
			const thumbsSwiper = new Swiper(thumbsSwiperEl, {
				modules: [Thumbs],
				spaceBetween: 10,
				slidesPerView: 4,
				watchSlidesProgress: true,
				breakpoints: {
					640: { slidesPerView: 4 },
					768: { slidesPerView: 5 },
					1024: { slidesPerView: 6 }
				}
			});
			
			const mainSwiper = new Swiper(mainSwiperEl, {
				modules: [Navigation, Pagination, Thumbs],
				spaceBetween: 10,
				navigation: {
					nextEl: '.swiper-button-next',
					prevEl: '.swiper-button-prev',
				},
				pagination: {
					el: '.swiper-pagination',
					clickable: true,
				},
				thumbs: {
					swiper: thumbsSwiper,
				},
				on: {
					slideChange: (swiper) => {
						events.galleryImageChanged(propertyId, swiper.activeIndex);
					}
				}
			});
		} else if (mainSwiperEl) {
			const mainSwiper = new Swiper(mainSwiperEl, {
				modules: [Navigation, Pagination],
				spaceBetween: 10,
				navigation: {
					nextEl: '.swiper-button-next',
					prevEl: '.swiper-button-prev',
				},
				pagination: {
					el: '.swiper-pagination',
					clickable: true,
				},
				on: {
					slideChange: (swiper) => {
						events.galleryImageChanged(propertyId, swiper.activeIndex);
					}
				}
			});
		}
	});
</script>

