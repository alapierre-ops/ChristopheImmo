---
import Layout from '../../layouts/Layout.astro';
import propertiesData from '../../data/properties.json';
import { processProperties, type Property } from '../../utils/properties';
import '../../styles/property-detail.css';
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/pagination';
import 'swiper/css/thumbs';

export async function getStaticPaths() {
	const properties: Property[] = await processProperties(propertiesData);
	return properties.map((property) => ({
		params: { id: property.id },
	}));
}

const { id } = Astro.params;
const properties: Property[] = await processProperties(propertiesData);
const property = properties.find(p => p.id === id);

// Redirect to index if property doesn't exist
if (!property) {
	return Astro.redirect('/');
}
---

<Layout title={property.title}>
	<main>
		<a href="/" class="back-link" id="back-link">
			<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<path d="M19 12H5M12 19l-7-7 7-7"/>
			</svg>
			Retour à la liste
		</a>

		<div class="container">
			<div class="property-header">
				<div class="property-title-section">
					<h1>{property.title}</h1>
					<p class="property-address">
						<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
							<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
							<circle cx="12" cy="10" r="3"/>
						</svg>
						{property.address}
					</p>
					<div class="property-badge">Disponible</div>
				</div>
				<div class="property-price-large">
					{property.isColocation ? (
						<>
							<div class="colocation-badge">Colocation</div>
							<span class="price-amount">{property.colocationPrice || property.price}</span>
							<span class="price-unit">€/mois par personne</span>
							{property.colocationDetails && (
								<span class="colocation-details">{property.colocationDetails}</span>
							)}
							<div class="total-price-note">
								Total : {property.price} €/mois
							</div>
						</>
					) : (
						<>
							<span class="price-amount">{property.price}</span>
							<span class="price-unit">€/mois</span>
						</>
					)}
					{property.priceNote && (
						<span class="water-included">{property.priceNote}</span>
					)}
				</div>
			</div>

			{property.images && property.images.length > 0 && (
				<div class="property-gallery">
					<div class="gallery-main">
						<div class="main-image-container" id="main-image-container">
							<img 
								src={property.images[0]} 
								alt={`${property.title} - Image principale`}
								class="main-image"
								id="main-image"
							/>
							<div class="image-overlay">
								<div class="image-counter">
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
										<circle cx="8.5" cy="8.5" r="1.5"/>
										<polyline points="21 15 16 10 5 21"/>
									</svg>
									<span id="current-image-index">1</span> / {property.images.length}
								</div>
								<button class="view-all-btn" id="view-all-btn">
									Voir toutes les photos
								</button>
							</div>
							{property.images.length > 1 && (
								<>
									<button class="gallery-nav-btn gallery-nav-prev" id="prev-btn">
										<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M15 18l-6-6 6-6"/>
										</svg>
									</button>
									<button class="gallery-nav-btn gallery-nav-next" id="next-btn">
										<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M9 18l6-6-6-6"/>
										</svg>
									</button>
								</>
							)}
						</div>
						{property.images.length > 1 && (
							<div class="gallery-grid">
								{property.images.slice(1, 5).map((image, index) => (
									<div 
										class={`gallery-thumb ${index === 3 && property.images.length > 5 ? 'has-more' : ''}`}
										data-image-index={index + 1}
									>
										<img src={image} alt={`${property.title} - Image ${index + 2}`} />
										{index === 3 && property.images.length > 5 && (
											<div class="more-images-overlay">
												+{property.images.length - 5}
											</div>
										)}
									</div>
								))}
							</div>
						)}
					</div>
					{property.images.length > 5 && (
						<div class="gallery-thumbnails" id="gallery-thumbnails">
							{property.images.map((image, index) => (
								<div 
									class={`thumbnail-item ${index === 0 ? 'active' : ''}`}
									data-image-index={index}
								>
									<img src={image} alt={`${property.title} - Miniature ${index + 1}`} />
								</div>
							))}
						</div>
					)}
				</div>
			)}

			<div class="property-content-grid">
				<div class="property-main">
					<section class="property-section">
						<h2>Description</h2>
						<div class="property-description-text">
							{property.longDescription ? (
								property.longDescription.split('\n\n').map((paragraph, index) => (
									paragraph.trim() && (
										<p key={index} class={paragraph.match(/^\d+\//) ? 'description-numbered' : ''}>
											{paragraph.split('\n').map((line, lineIndex) => (
												<span key={lineIndex}>
													{line.trim()}
													{lineIndex < paragraph.split('\n').length - 1 && <br />}
												</span>
											))}
										</p>
									)
								))
							) : (
								<p>{property.description || property.shortDescription}</p>
							)}
						</div>
					</section>

					{property.features && property.features.length > 0 && (
						<section class="property-section">
							<h2>Caractéristiques</h2>
							<div class="features-grid">
								{property.features.map((feature) => (
									<div class="feature-item">
										<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<polyline points="20 6 9 17 4 12"/>
										</svg>
										{feature}
									</div>
								))}
							</div>
						</section>
					)}
				</div>

				<aside class="property-sidebar">
					<div class="info-card">
						<h3>Informations</h3>
						<div class="info-item">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
								<line x1="9" y1="3" x2="9" y2="21"/>
								<line x1="3" y1="9" x2="21" y2="9"/>
							</svg>
							<div>
								<div class="info-label">Surface</div>
								<div class="info-value">{property.surface} m²</div>
							</div>
						</div>
						<div class="info-item">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
								<polyline points="9 22 9 12 15 12 15 22"/>
							</svg>
							<div>
								<div class="info-label">Pièces</div>
								<div class="info-value">{property.rooms} pièce{property.rooms > 1 ? 's' : ''}</div>
							</div>
						</div>
						{property.floor && (
							<div class="info-item">
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
									<polyline points="9 22 9 12 15 12 15 22"/>
								</svg>
								<div>
									<div class="info-label">Étage</div>
									<div class="info-value">{property.floor}</div>
								</div>
							</div>
						)}
						<div class="info-item">
							<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
								<line x1="12" y1="1" x2="12" y2="23"/>
								<path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
							</svg>
							<div>
								<div class="info-label">Loyer</div>
								<div class="info-value">
									{property.isColocation ? (
										<>
											<span class="colocation-price-main">{property.colocationPrice || property.price} €/mois</span>
											<span class="colocation-price-label">par personne</span>
											{property.colocationDetails && (
												<div class="colocation-details-small">{property.colocationDetails}</div>
											)}
											<div class="total-price-small">Total : {property.price} €/mois</div>
										</>
									) : (
										<>
											{property.price} €/mois
											{property.priceNote && (
												<span class="water-included">{property.priceNote}</span>
											)}
										</>
									)}
								</div>
							</div>
						</div>
						{property.leaseType && (
							<div class="info-item">
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
									<polyline points="14 2 14 8 20 8"/>
									<line x1="16" y1="13" x2="8" y2="13"/>
									<line x1="16" y1="17" x2="8" y2="17"/>
									<polyline points="10 9 9 9 8 9"/>
								</svg>
								<div>
									<div class="info-label">Type de bail</div>
									<div class="info-value">{property.leaseType}</div>
								</div>
							</div>
						)}
						{property.leasePeriod && (
							<div class="info-item">
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
									<line x1="16" y1="2" x2="16" y2="6"/>
									<line x1="8" y1="2" x2="8" y2="6"/>
									<line x1="3" y1="10" x2="21" y2="10"/>
								</svg>
								<div>
									<div class="info-label">Période</div>
									<div class="info-value">{property.leasePeriod}</div>
								</div>
							</div>
						)}
					</div>

					{property.additionalCharges && (property.additionalCharges.edf || property.additionalCharges.internet || property.additionalCharges.deposit) && (
						<div class="info-card">
							<h3>Charges supplémentaires</h3>
							{property.additionalCharges.edf && (
								<div class="info-item">
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<circle cx="12" cy="12" r="10"/>
										<polyline points="12 6 12 12 16 14"/>
									</svg>
									<div>
										<div class="info-label">Électricité</div>
										<div class="info-value">{property.additionalCharges.edf}</div>
									</div>
								</div>
							)}
							{property.additionalCharges.internet && (
								<div class="info-item">
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<circle cx="12" cy="12" r="10"/>
										<line x1="2" y1="12" x2="22" y2="12"/>
										<path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
									</svg>
									<div>
										<div class="info-label">Internet</div>
										<div class="info-value">{property.additionalCharges.internet}</div>
									</div>
								</div>
							)}
							{property.additionalCharges.deposit && (
								<div class="info-item">
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
										<path d="M7 11V7a5 5 0 0 1 10 0v4"/>
									</svg>
									<div>
										<div class="info-label">Caution</div>
										<div class="info-value">{property.additionalCharges.deposit}</div>
									</div>
								</div>
							)}
						</div>
					)}

					{property.parking && (
						<div class="info-card">
							<h3>Parking</h3>
							<div class="info-item">
								<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
									<path d="M3 9h18M9 3v18"/>
								</svg>
								<div>
									<div class="info-label">Parking</div>
									<div class="info-value">{property.parking}</div>
								</div>
							</div>
						</div>
					)}

					<div class="contact-card">
						<h3>Intéressé(e) ?</h3>
						<p>Contactez-moi pour organiser une visite ou obtenir plus d'informations.</p>
						<div class="contact-buttons">
							<a 
								href="mailto:christophe-lapierre@orange.fr" 
								class="btn btn-primary"
								id="email-button"
								data-property-id={property.id}
								data-property-title={property.title}
							>
								<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
									<polyline points="22,6 12,13 2,6"/>
								</svg>
								Envoyer un email
							</a>
							<a 
								href="tel:+33601767543" 
								class="btn btn-secondary"
								id="phone-button"
								data-property-id={property.id}
								data-property-title={property.title}
							>
								<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
									<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
								</svg>
								Appeler
							</a>
						</div>
					</div>
				</aside>
			</div>
		</div>
	</main>
</Layout>

<script define:vars={{ propertyId: property.id, propertyTitle: property.title, propertyImages: property.images }}>
	// Inline PostHog tracking functions
	function trackEvent(eventName, properties) {
		if (typeof window !== 'undefined' && window.posthog) {
			window.posthog.capture(eventName, properties);
		}
	}
	
	const events = {
		propertyViewed: (propertyId, propertyTitle) => 
			trackEvent('property_viewed', { property_id: propertyId, property_title: propertyTitle }),
		backToListClicked: () => 
			trackEvent('back_to_list_clicked'),
		emailClicked: (propertyId, propertyTitle) => 
			trackEvent('email_clicked', { property_id: propertyId, property_title: propertyTitle }),
		phoneClicked: (propertyId, propertyTitle) => 
			trackEvent('phone_clicked', { property_id: propertyId, property_title: propertyTitle }),
		galleryImageChanged: (propertyId, imageIndex) => 
			trackEvent('gallery_image_changed', { property_id: propertyId, image_index: imageIndex }),
	};
	
	events.propertyViewed(propertyId, propertyTitle);
	
	document.addEventListener('DOMContentLoaded', () => {
		const imageList = propertyImages || [];
		let currentImageIndex = 0;
		let fullscreenIndex = 0;
		let touchStartX = 0;
		let touchEndX = 0;
		
		const mainImage = document.getElementById('main-image');
		const mainImageContainer = document.getElementById('main-image-container');
		const currentImageIndexEl = document.getElementById('current-image-index');
		const prevBtn = document.getElementById('prev-btn');
		const nextBtn = document.getElementById('next-btn');
		const viewAllBtn = document.getElementById('view-all-btn');
		const galleryThumbs = document.querySelectorAll('.gallery-thumb');
		const thumbnailItems = document.querySelectorAll('.thumbnail-item');
		
		// Fullscreen modal elements
		let fullscreenModal = null;
		let fullscreenImage = null;
		let fullscreenCounter = null;
		let fullscreenPrevBtn = null;
		let fullscreenNextBtn = null;
		let fullscreenCloseBtn = null;
		
		function createFullscreenModal() {
			if (fullscreenModal) return;
			
			fullscreenModal = document.createElement('div');
			fullscreenModal.className = 'fullscreen-modal';
			fullscreenModal.innerHTML = `
				<button class="fullscreen-close" aria-label="Fermer">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<line x1="18" y1="6" x2="6" y2="18"/>
						<line x1="6" y1="6" x2="18" y2="18"/>
					</svg>
				</button>
				<button class="fullscreen-nav fullscreen-prev" aria-label="Image précédente">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M15 18l-6-6 6-6"/>
					</svg>
				</button>
				<button class="fullscreen-nav fullscreen-next" aria-label="Image suivante">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M9 18l6-6-6-6"/>
					</svg>
				</button>
				<div class="fullscreen-content">
					<img class="fullscreen-img" src="" alt="" />
					<div class="fullscreen-counter">
						<span class="fullscreen-current">1</span> / <span class="fullscreen-total">${imageList.length}</span>
					</div>
				</div>
			`;
			document.body.appendChild(fullscreenModal);
			
			fullscreenImage = fullscreenModal.querySelector('.fullscreen-img');
			fullscreenCounter = fullscreenModal.querySelector('.fullscreen-current');
			fullscreenPrevBtn = fullscreenModal.querySelector('.fullscreen-prev');
			fullscreenNextBtn = fullscreenModal.querySelector('.fullscreen-next');
			fullscreenCloseBtn = fullscreenModal.querySelector('.fullscreen-close');
			
			// Close modal handlers
			fullscreenCloseBtn?.addEventListener('click', closeFullscreen);
			fullscreenModal.addEventListener('click', (e) => {
				if (e.target === fullscreenModal) {
					closeFullscreen();
				}
			});
			
			// Navigation in fullscreen
			fullscreenPrevBtn?.addEventListener('click', (e) => {
				e.stopPropagation();
				if (fullscreenIndex > 0) {
					updateFullscreenImage(fullscreenIndex - 1);
				}
			});
			
			fullscreenNextBtn?.addEventListener('click', (e) => {
				e.stopPropagation();
				if (fullscreenIndex < imageList.length - 1) {
					updateFullscreenImage(fullscreenIndex + 1);
				}
			});
			
			// Keyboard navigation in fullscreen
			document.addEventListener('keydown', handleFullscreenKeyboard);
			
			// Touch swipe in fullscreen
			let fullscreenTouchStartX = 0;
			let fullscreenTouchEndX = 0;
			
			fullscreenModal.addEventListener('touchstart', (e) => {
				fullscreenTouchStartX = e.changedTouches[0].screenX;
			}, { passive: true });
			
			fullscreenModal.addEventListener('touchend', (e) => {
				fullscreenTouchEndX = e.changedTouches[0].screenX;
				handleFullscreenSwipe();
			}, { passive: true });
			
			function handleFullscreenSwipe() {
				const swipeThreshold = 50;
				const diff = fullscreenTouchStartX - fullscreenTouchEndX;
				
				if (Math.abs(diff) > swipeThreshold) {
					if (diff > 0 && fullscreenIndex < imageList.length - 1) {
						updateFullscreenImage(fullscreenIndex + 1);
					} else if (diff < 0 && fullscreenIndex > 0) {
						updateFullscreenImage(fullscreenIndex - 1);
					}
				}
			}
		}
		
		function openFullscreen(index) {
			if (!imageList || imageList.length === 0) return;
			if (index < 0 || index >= imageList.length) return;
			
			createFullscreenModal();
			if (!fullscreenModal) return;
			
			fullscreenIndex = index;
			updateFullscreenImage(index);
			fullscreenModal.classList.add('active');
			document.body.style.overflow = 'hidden';
		}
		
		function closeFullscreen() {
			if (!fullscreenModal) return;
			fullscreenModal.classList.remove('active');
			document.body.style.overflow = '';
			document.removeEventListener('keydown', handleFullscreenKeyboard);
		}
		
		function updateFullscreenImage(index) {
			if (!fullscreenImage || !fullscreenCounter || !imageList || imageList.length === 0) return;
			
			fullscreenIndex = index;
			fullscreenImage.src = imageList[index];
			fullscreenImage.alt = `${propertyTitle} - Image ${index + 1}`;
			fullscreenCounter.textContent = String(index + 1);
			
			// Update navigation buttons
			if (fullscreenPrevBtn) {
				fullscreenPrevBtn.style.opacity = index === 0 ? '0.3' : '1';
				fullscreenPrevBtn.style.pointerEvents = index === 0 ? 'none' : 'auto';
			}
			if (fullscreenNextBtn) {
				fullscreenNextBtn.style.opacity = index === imageList.length - 1 ? '0.3' : '1';
				fullscreenNextBtn.style.pointerEvents = index === imageList.length - 1 ? 'none' : 'auto';
			}
			
			events.galleryImageChanged(propertyId, index);
		}
		
		function handleFullscreenKeyboard(e) {
			if (!fullscreenModal?.classList.contains('active')) return;
			
			if (e.key === 'Escape') {
				closeFullscreen();
			} else if (e.key === 'ArrowLeft' && fullscreenIndex > 0) {
				updateFullscreenImage(fullscreenIndex - 1);
			} else if (e.key === 'ArrowRight' && fullscreenIndex < imageList.length - 1) {
				updateFullscreenImage(fullscreenIndex + 1);
			}
		}
		
		function updateMainImage(index) {
			if (!mainImage || !imageList || imageList.length === 0) return;
			
			currentImageIndex = index;
			mainImage.src = imageList[index];
			
			if (currentImageIndexEl) {
				currentImageIndexEl.textContent = String(index + 1);
			}
			
			// Update active states
			galleryThumbs.forEach((thumb, i) => {
				thumb.classList.toggle('active', i + 1 === index);
			});
			
			thumbnailItems.forEach((item, i) => {
				item.classList.toggle('active', i === index);
			});
			
			// Update navigation buttons visibility
			if (prevBtn) {
				prevBtn.style.opacity = index === 0 ? '0.5' : '1';
				prevBtn.style.pointerEvents = index === 0 ? 'none' : 'auto';
			}
			if (nextBtn) {
				nextBtn.style.opacity = index === imageList.length - 1 ? '0.5' : '1';
				nextBtn.style.pointerEvents = index === imageList.length - 1 ? 'none' : 'auto';
			}
			
			events.galleryImageChanged(propertyId, index);
		}
		
		// Initialize button states
		if (prevBtn && imageList.length > 0) {
			prevBtn.style.opacity = '0.5';
			prevBtn.style.pointerEvents = 'none';
		}
		
		// Click on main image to open fullscreen
		if (mainImageContainer) {
			mainImageContainer.addEventListener('click', (e) => {
				// Don't open fullscreen if clicking on buttons
				const target = e.target;
				if (target && target.closest && (target.closest('.gallery-nav-btn') || target.closest('.view-all-btn') || target.closest('.image-counter'))) {
					return;
				}
				openFullscreen(currentImageIndex);
			});
		}
		
		// Navigation buttons
		if (prevBtn) {
			prevBtn.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				if (currentImageIndex > 0) {
					updateMainImage(currentImageIndex - 1);
				}
			});
		}
		
		if (nextBtn) {
			nextBtn.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				if (currentImageIndex < imageList.length - 1) {
					updateMainImage(currentImageIndex + 1);
				}
			});
		}
		
		// Gallery thumbnails click
		galleryThumbs.forEach((thumb) => {
			thumb.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				const index = parseInt(thumb.getAttribute('data-image-index') || '0');
				updateMainImage(index);
			});
		});
		
		// Thumbnail items click - open fullscreen
		thumbnailItems.forEach((item) => {
			item.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				const index = parseInt(item.getAttribute('data-image-index') || '0');
				updateMainImage(index);
				openFullscreen(index);
			});
		});
		
		// View all button - open fullscreen
		if (viewAllBtn) {
			viewAllBtn.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				openFullscreen(currentImageIndex);
			});
		}
		
		// Touch swipe support for main image
		if (mainImageContainer) {
			mainImageContainer.addEventListener('touchstart', (e) => {
				touchStartX = e.changedTouches[0].screenX;
			}, { passive: true });
			
			mainImageContainer.addEventListener('touchend', (e) => {
				touchEndX = e.changedTouches[0].screenX;
				handleSwipe();
			}, { passive: true });
		}
		
		function handleSwipe() {
			const swipeThreshold = 50;
			const diff = touchStartX - touchEndX;
			
			if (Math.abs(diff) > swipeThreshold) {
				if (diff > 0 && currentImageIndex < imageList.length - 1) {
					updateMainImage(currentImageIndex + 1);
				} else if (diff < 0 && currentImageIndex > 0) {
					updateMainImage(currentImageIndex - 1);
				}
			}
		}
		
		// Keyboard navigation
		document.addEventListener('keydown', (e) => {
			if (fullscreenModal?.classList.contains('active')) return;
			
			if (mainImageContainer && document.activeElement === document.body) {
				if (e.key === 'ArrowLeft' && currentImageIndex > 0) {
					updateMainImage(currentImageIndex - 1);
				} else if (e.key === 'ArrowRight' && currentImageIndex < imageList.length - 1) {
					updateMainImage(currentImageIndex + 1);
				}
			}
		});
		
		const backLink = document.getElementById('back-link');
		if (backLink) {
			backLink.addEventListener('click', () => {
				events.backToListClicked();
			});
		}
		
		const emailButton = document.getElementById('email-button');
		if (emailButton) {
			emailButton.addEventListener('click', () => {
				events.emailClicked(propertyId, propertyTitle);
			});
		}
		
		const phoneButton = document.getElementById('phone-button');
		if (phoneButton) {
			phoneButton.addEventListener('click', () => {
				events.phoneClicked(propertyId, propertyTitle);
			});
		}
	});
</script>

