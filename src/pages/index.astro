---
import Layout from '../layouts/Layout.astro';
import propertiesData from '../data/properties.json';
import IntroSection from '../components/IntroSection.astro';
import InfoSection from '../components/InfoSection.astro';
import VisitsSection from '../components/VisitsSection.astro';
import { processProperties, type Property } from '../utils/properties';
import '../styles/index.css';

const properties: Property[] = await processProperties(propertiesData);
const totalProperties = properties.length;
const averagePrice = Math.round(properties.reduce((sum, p) => sum + p.price, 0) / properties.length);
---

<Layout title="Propriétés à louer">
	<main>
		<header class="header">
			<div class="container">
				<h1>Découvrez mes logements</h1>
				<p class="subtitle">Pour étudiants et artistes</p>
			</div>
		</header>

		<div class="container">
			<IntroSection />

			<section class="properties-section">
				<div class="section-header">
					<h2>Mes biens disponibles</h2>
					<p>Consultez mon catalogue de propriétés à louer</p>
				</div>

				<div class="properties-grid">
					{properties.map((property) => (
						<a 
							href={`/bien/${property.id}`} 
							class="property-card"
							data-property-id={property.id}
							data-property-title={property.title}
						>
							<div class="property-badge">Disponible</div>
							<div class="property-image">
								{property.images && property.images.length > 0 ? (
									<>
										<img src={property.images[0]} alt={property.title} />
										{property.images.length > 1 && (
											<div class="image-count">
												<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
													<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
													<circle cx="8.5" cy="8.5" r="1.5"/>
													<polyline points="21 15 16 10 5 21"/>
												</svg>
												{property.images.length} photos
											</div>
										)}
									</>
								) : (
									<div class="placeholder-image">Pas d'image</div>
								)}
							</div>
							<div class="property-content">
								<h2 class="property-title">{property.title}</h2>
								<p class="property-address">
									<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
										<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
										<circle cx="12" cy="10" r="3"/>
									</svg>
									{property.address}
								</p>
								<p class="property-description">{property.shortDescription}</p>
								<div class="property-details">
									<span class="detail-item">
										<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
											<line x1="9" y1="3" x2="9" y2="21"/>
											<line x1="3" y1="9" x2="21" y2="9"/>
										</svg>
										{property.surface} m²
									</span>
									<span class="detail-item">
										<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
											<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
											<polyline points="9 22 9 12 15 12 15 22"/>
										</svg>
										{property.rooms} pièce{property.rooms > 1 ? 's' : ''}
									</span>
								</div>
								{property.features && property.features.length > 0 && (
									<div class="property-features">
										{property.features.slice(0, 4).map((feature) => (
											<span class="feature-tag">{feature}</span>
										))}
									</div>
								)}
								<div class="property-price">
									{property.isColocation ? (
										<>
											<span class="colocation-badge-small">Colocation</span>
											<span class="price-main">{property.colocationPrice || property.price} €/mois</span>
											<span class="price-per-person">par personne</span>
										</>
									) : (
										<>
											{property.price} €/mois
										</>
									)}
									{property.priceNote && (
										<span class="water-included">{property.priceNote}</span>
									)}
								</div>
							</div>
						</a>
					))}
				</div>
			</section>

			<InfoSection />
			<VisitsSection />
		</div>

		<footer class="footer">
			<div class="container">
				<div class="footer-content">
					<div class="footer-section">
						<h3>Contact</h3>
						<p>Pour toute information ou visite, n'hésitez pas à me contacter.</p>
						<p>
							<a href="mailto:christophe-lapierre@orange.fr">christophe-lapierre@orange.fr</a>
						</p>
						<p>
							<a href="tel:+33601767543">+33 6 01 76 75 43</a>
						</p>
					</div>
				</div>
				<div class="footer-bottom">
					<p>&copy; {new Date().getFullYear()} Christophe Lapierre. Tous droits réservés.</p>
				</div>
			</div>
		</footer>
	</main>
</Layout>

<script>
	import { events } from '../utils/posthog';
	
	events.pageView('home');
	
	document.addEventListener('DOMContentLoaded', () => {
		const propertyCards = document.querySelectorAll('.property-card');
		propertyCards.forEach((card) => {
			card.addEventListener('click', () => {
				const propertyId = card.getAttribute('data-property-id');
				const propertyTitle = card.getAttribute('data-property-title');
				if (propertyId && propertyTitle) {
					events.propertyCardClicked(propertyId, propertyTitle);
				}
			});
		});
	});
</script>